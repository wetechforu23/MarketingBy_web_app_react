{% extends "base.html" %}

{% block title %}API Quota Monitor{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-chart-line me-2"></i>API Quota Monitor</h1>
                <button class="btn btn-outline-primary" onclick="refreshQuota()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- New Pricing Model Notice -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info" role="alert">
                <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Updated Google Places API Pricing (2025)</h5>
                <p class="mb-2">Updated Google Places API pricing (2024-2025):</p>
                <ul class="mb-0">
                    <li><strong>Free Tier:</strong> $200 monthly credit (~100,000 requests/month)</li>
                    <li><strong>Daily Limit:</strong> ~3,333 requests per day (100,000 รท 30 days)</li>
                    <li><strong>Safety Limit:</strong> 3,000 requests per day (90% of daily limit)</li>
                    <li><strong>Cost per Request:</strong> $0.002 average (varies by request type)</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Quota Status Cards -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-calendar-day me-2"></i>Daily Usage</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Requests Made:</span>
                        <strong id="daily-requests">0</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Remaining:</span>
                        <strong id="daily-remaining">800</strong>
                    </div>
                    <div class="progress mb-2">
                        <div class="progress-bar" id="daily-progress" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted" id="daily-percentage">0% used</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Monthly Usage</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Requests Made:</span>
                        <strong id="monthly-requests">0</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Remaining:</span>
                        <strong id="monthly-remaining">80000</strong>
                    </div>
                    <div class="progress mb-2">
                        <div class="progress-bar bg-info" id="monthly-progress" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted" id="monthly-percentage">0% used</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Cost Estimate -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Cost Estimate</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-success mb-1" id="monthly-cost">$0.00</h3>
                                <small class="text-muted">Monthly Cost</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-primary mb-1" id="cost-per-request">$0.002</h3>
                                <small class="text-muted">Cost per Request (2024-2025)</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-info mb-1" id="quota-status">SAFE</h3>
                                <small class="text-muted">Status</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quota Warnings -->
    <div class="row mb-4" id="quota-warnings" style="display: none;">
        <div class="col-12">
            <div class="alert alert-warning" role="alert">
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Quota Warning</h5>
                <p class="mb-0" id="warning-message"></p>
            </div>
        </div>
    </div>

    <!-- Usage History -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Usage History</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Requests Made</th>
                                    <th>Cost</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="usage-history">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quota Management Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Quota Management</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <button class="btn btn-outline-primary w-100" onclick="resetDailyQuota()">
                                <i class="fas fa-redo me-1"></i>Reset Daily Quota
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-warning w-100" onclick="cleanupOldData()">
                                <i class="fas fa-trash me-1"></i>Cleanup Old Data
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-danger w-100" onclick="resetMonthlyQuota()">
                                <i class="fas fa-calendar-alt me-1"></i>Reset Monthly Quota
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-info w-100" onclick="exportQuotaData()">
                                <i class="fas fa-download me-1"></i>Export Data
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-success w-100" onclick="refreshQuota()">
                                <i class="fas fa-sync-alt me-1"></i>Refresh Status
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load quota data on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshQuota();
    // Auto-refresh every 30 seconds
    setInterval(refreshQuota, 30000);
});

function refreshQuota() {
    fetch('/admin/quota/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateQuotaDisplay(data.quota);
            } else {
                console.error('Error loading quota data:', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function updateQuotaDisplay(quota) {
    // Update daily usage
    document.getElementById('daily-requests').textContent = quota.today.requests_made;
    document.getElementById('daily-remaining').textContent = quota.today.remaining;
    document.getElementById('daily-percentage').textContent = `${quota.today.percentage.toFixed(1)}% used`;
    
    const dailyProgress = document.getElementById('daily-progress');
    dailyProgress.style.width = `${quota.today.percentage}%`;
    
    // Color coding for progress bar
    if (quota.today.percentage > 90) {
        dailyProgress.className = 'progress-bar bg-danger';
    } else if (quota.today.percentage > 70) {
        dailyProgress.className = 'progress-bar bg-warning';
    } else {
        dailyProgress.className = 'progress-bar bg-success';
    }
    
    // Update monthly usage
    document.getElementById('monthly-requests').textContent = quota.monthly.requests_made;
    document.getElementById('monthly-remaining').textContent = quota.monthly.remaining;
    document.getElementById('monthly-percentage').textContent = `${quota.monthly.percentage.toFixed(1)}% used`;
    
    const monthlyProgress = document.getElementById('monthly-progress');
    monthlyProgress.style.width = `${quota.monthly.percentage}%`;
    
    // Update cost and status
    document.getElementById('monthly-cost').textContent = `$${quota.cost_estimate.toFixed(2)}`;
    document.getElementById('quota-status').textContent = quota.status;
    
    // Update status color
    const statusElement = document.getElementById('quota-status');
    if (quota.status === 'SAFE') {
        statusElement.className = 'text-success';
    } else if (quota.status === 'WARNING') {
        statusElement.className = 'text-warning';
    } else {
        statusElement.className = 'text-danger';
    }
    
    // Show/hide warnings with appropriate styling
    const warningsDiv = document.getElementById('quota-warnings');
    if (quota.warning) {
        const warningMessage = document.getElementById('warning-message');
        warningMessage.textContent = quota.warning;
        
        // Style based on warning type
        const alertDiv = warningsDiv.querySelector('.alert');
        if (quota.warning.includes('CRITICAL')) {
            alertDiv.className = 'alert alert-danger';
        } else if (quota.warning.includes('WARNING')) {
            alertDiv.className = 'alert alert-warning';
        } else if (quota.warning.includes('CAUTION')) {
            alertDiv.className = 'alert alert-info';
        } else {
            alertDiv.className = 'alert alert-warning';
        }
        
        warningsDiv.style.display = 'block';
    } else {
        warningsDiv.style.display = 'none';
    }
}

function resetDailyQuota() {
    if (confirm('Are you sure you want to reset the daily quota? This will clear today\'s usage data.')) {
        fetch('/admin/quota/reset-daily', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Daily quota reset successfully!');
                refreshQuota();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}

function cleanupOldData() {
    if (confirm('Are you sure you want to cleanup old quota data? This will remove data older than 30 days.')) {
        fetch('/admin/quota/cleanup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Old data cleaned up successfully!');
                refreshQuota();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}

function exportQuotaData() {
    fetch('/admin/quota/export')
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quota_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        })
        .catch(error => {
            alert('Error exporting data: ' + error);
        });
}

function resetMonthlyQuota() {
    if (confirm('Are you sure you want to reset the monthly quota? This will clear all usage data for the current month and cannot be undone.')) {
        if (confirm('This will reset ALL monthly usage data. Are you absolutely sure?')) {
            fetch('/admin/quota/reset-monthly', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Monthly quota reset successfully!');
                    refreshQuota();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }
    }
}
</script>
{% endblock %}
