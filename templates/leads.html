<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Management - Health Clinic Marketing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
        }
        .nav-link {
            color: #ecf0f1;
            transition: all 0.3s;
        }
        .nav-link:hover {
            color: #3498db;
            background-color: rgba(52, 152, 219, 0.1);
        }
        .nav-link.active {
            background-color: #3498db;
            color: white;
        }
        .lead-card {
            transition: all 0.3s;
            border-left: 4px solid #e74c3c;
        }
        .lead-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .status-new { border-left-color: #e74c3c; }
        .status-contacted { border-left-color: #f39c12; }
        .status-qualified { border-left-color: #3498db; }
        .status-proposal-sent { border-left-color: #9b59b6; }
        .status-converted { border-left-color: #27ae60; }
        .status-closed { border-left-color: #95a5a6; }
        .status-cancelled { border-left-color: #7f8c8d; }
        
        .badge-new { background-color: #e74c3c; }
        .badge-contacted { background-color: #f39c12; }
        .badge-qualified { background-color: #3498db; }
        .badge-proposal-sent { background-color: #9b59b6; }
        .badge-converted { background-color: #27ae60; }
        .badge-closed { background-color: #95a5a6; }
        .badge-cancelled { background-color: #7f8c8d; }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-none d-md-block sidebar">
                <div class="sidebar-sticky p-3">
                    <h4 class="text-white mb-4">
                        <i class="fas fa-heartbeat"></i> HealthMarketing
                    </h4>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/clients">
                                <i class="fas fa-users"></i> Clients
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/leads">
                                <i class="fas fa-user-plus"></i> Leads
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/campaigns">
                                <i class="fas fa-bullhorn"></i> Campaigns
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/scrape_clinics">
                                <i class="fas fa-search"></i> Clinic Scraper
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/seo_audit">
                                <i class="fas fa-chart-line"></i> SEO Audit
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/analytics">
                                <i class="fas fa-analytics"></i> Analytics
                            </a>
                        </li>
                        <li class="nav-item mt-3">
                            <a class="nav-link text-danger" href="/logout">
                                <i class="fas fa-sign-out-alt"></i> Sign Out
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-10 ml-sm-auto px-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <div>
                        <h1 class="h2">
                            <i class="fas fa-user-plus text-primary me-2"></i>Lead Management
                        </h1>
                        <p class="text-muted">Manage prospects and convert them to clients</p>
                    </div>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <a href="/scrape_clinics" class="btn btn-primary me-2">
                            <i class="fas fa-search me-2"></i>Find New Leads
                        </a>
                        <button class="btn btn-success" onclick="exportLeads()">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                    </div>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Lead Statistics -->
                <div class="row mb-4">
                    {% set total_leads = leads|length %}
                    {% set new_leads = leads|selectattr('lead_status', 'equalto', 'new')|list|length %}
                    {% set qualified_leads = leads|selectattr('lead_status', 'equalto', 'qualified')|list|length %}
                    {% set converted_leads = leads|selectattr('lead_status', 'equalto', 'converted')|list|length %}
                    
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-user-plus fa-2x text-primary mb-2"></i>
                                <h4>{{ total_leads }}</h4>
                                <p class="text-muted mb-0">Total Leads</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-star fa-2x text-warning mb-2"></i>
                                <h4>{{ new_leads }}</h4>
                                <p class="text-muted mb-0">New Leads</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-check-circle fa-2x text-info mb-2"></i>
                                <h4>{{ qualified_leads }}</h4>
                                <p class="text-muted mb-0">Qualified</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-handshake fa-2x text-success mb-2"></i>
                                <h4>{{ converted_leads }}</h4>
                                <p class="text-muted mb-0">Converted</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Leads Table -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">All Leads ({{ leads|length }})</h5>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="filterLeads('all')">All</button>
                            <button class="btn btn-outline-warning" onclick="filterLeads('new')">New</button>
                            <button class="btn btn-outline-info" onclick="filterLeads('contacted')">Contacted</button>
                            <button class="btn btn-outline-primary" onclick="filterLeads('qualified')">Qualified</button>
                            <button class="btn btn-outline-success" onclick="filterLeads('converted')">Converted</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        {% if leads %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Clinic Name</th>
                                        <th>Contact Info</th>
                                        <th>Specialties</th>
                                        <th>Status</th>
                                        <th>Rating</th>
                                        <th>Added</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for lead in leads %}
                                    <tr class="lead-row status-{{ lead.lead_status }}" data-status="{{ lead.lead_status }}">
                                        <td>
                                            <div>
                                                <strong>{{ lead.clinic_name }}</strong>
                                                {% if lead.website %}
                                                <br><a href="{{ lead.website }}" target="_blank" class="text-muted small">
                                                    <i class="fas fa-globe"></i> {{ lead.website }}
                                                </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            {% if lead.phone %}
                                            <div><i class="fas fa-phone text-muted"></i> {{ lead.phone }}</div>
                                            {% endif %}
                                            {% if lead.email %}
                                            <div><i class="fas fa-envelope text-muted"></i> {{ lead.email }}</div>
                                            {% endif %}
                                            {% if lead.address %}
                                            <div class="small text-muted">{{ lead.address[:50] }}{% if lead.address|length > 50 %}...{% endif %}</div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="small">{{ lead.specialties[:40] if lead.specialties else 'N/A' }}{% if lead.specialties and lead.specialties|length > 40 %}...{% endif %}</span>
                                        </td>
                                        <td>
                                            <span class="badge badge-{{ lead.lead_status }} text-white">
                                                {{ lead.lead_status.replace('_', ' ').title() }}
                                            </span>
                                            {% if lead.contacted %}
                                            <br><small class="text-success"><i class="fas fa-check"></i> Contacted</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if lead.rating %}
                                            <div>
                                                <span class="text-warning">
                                                    {% for i in range(1, 6) %}
                                                        {% if i <= lead.rating %}
                                                            <i class="fas fa-star"></i>
                                                        {% else %}
                                                            <i class="far fa-star"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                </span>
                                                <br><small class="text-muted">{{ lead.review_count or 0 }} reviews</small>
                                            </div>
                                            {% else %}
                                            <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ lead.created_at.strftime('%m/%d/%Y') }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                                                    <i class="fas fa-cog"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="showUpdateModal({{ lead.id }}, '{{ lead.clinic_name }}', '{{ lead.lead_status }}')">
                                                        <i class="fas fa-edit"></i> Update Status
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="showNotesModal({{ lead.id }}, '{{ lead.clinic_name }}')">
                                                        <i class="fas fa-sticky-note"></i> Add Notes
                                                    </a></li>
                                                    {% if lead.website %}
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item" href="#" onclick="runSEOAudit({{ lead.id }})">
                                                        <i class="fas fa-chart-line"></i> SEO Audit
                                                    </a></li>
                                                    {% endif %}
                                                    <li><a class="dropdown-item" href="#" onclick="contactLead('{{ lead.clinic_name }}', '{{ lead.email or '' }}')">
                                                        <i class="fas fa-envelope"></i> Send Email
                                                    </a></li>
                                                    {% if lead.lead_status not in ['converted', 'cancelled'] %}
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-success" href="#" onclick="showConvertModal({{ lead.id }}, '{{ lead.clinic_name }}')">
                                                        <i class="fas fa-handshake"></i> Convert to Client
                                                    </a></li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-user-plus fa-3x text-muted mb-3"></i>
                            <h5>No Leads Found</h5>
                            <p class="text-muted">Use the Clinic Scraper to find new leads for your business.</p>
                            <a href="/scrape_clinics" class="btn btn-primary">
                                <i class="fas fa-search me-2"></i>Find New Leads
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div class="modal fade" id="updateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="updateForm" method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title">Update Lead Status</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status" required>
                                <option value="new">New</option>
                                <option value="contacted">Contacted</option>
                                <option value="qualified">Qualified</option>
                                <option value="proposal_sent">Proposal Sent</option>
                                <option value="closed">Closed (No Sale)</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" name="notes" rows="3" placeholder="Add any notes about this status change..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Lead</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Convert to Client Modal -->
    <div class="modal fade" id="convertModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="convertForm" method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title">Convert Lead to Client</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            This will create a new client record and mark the lead as converted.
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Monthly Retainer</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="monthly_retainer" value="2500" min="0" step="100">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Convert to Client</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showUpdateModal(leadId, clinicName, currentStatus) {
            document.getElementById('updateForm').action = `/leads/${leadId}/update`;
            document.querySelector('#updateModal .modal-title').textContent = `Update Status - ${clinicName}`;
            document.querySelector('#updateModal select[name="status"]').value = currentStatus;
            new bootstrap.Modal(document.getElementById('updateModal')).show();
        }

        function showConvertModal(leadId, clinicName) {
            document.getElementById('convertForm').action = `/leads/${leadId}/convert`;
            document.querySelector('#convertModal .modal-title').textContent = `Convert ${clinicName} to Client`;
            new bootstrap.Modal(document.getElementById('convertModal')).show();
        }

        function showNotesModal(leadId, clinicName) {
            document.getElementById('updateForm').action = `/leads/${leadId}/update`;
            document.querySelector('#updateModal .modal-title').textContent = `Add Notes - ${clinicName}`;
            document.querySelector('#updateModal select[name="status"]').style.display = 'none';
            document.querySelector('#updateModal select[name="status"]').previousElementSibling.style.display = 'none';
            new bootstrap.Modal(document.getElementById('updateModal')).show();
        }

        function runSEOAudit(leadId) {
            if (confirm('Run SEO audit for this lead? This will analyze their website performance.')) {
                fetch(`/leads/${leadId}/seo-audit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('SEO audit completed successfully!');
                        location.reload();
                    } else {
                        alert('Error running SEO audit: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error running SEO audit');
                });
            }
        }

        function contactLead(clinicName, email) {
            const subject = `Partnership Opportunity - Digital Marketing Services for ${clinicName}`;
            const body = `Dear ${clinicName} Team,

I hope this message finds you well. I'm reaching out from WeTechForU Marketing Solutions to discuss how we can help ${clinicName} grow your patient base and improve your online presence.

Our comprehensive digital marketing services include:
• SEO optimization to improve Google search rankings
• Social media management and patient engagement
• Google Ads campaigns for targeted patient acquisition
• Professional website development and maintenance
• Online reputation management

We specialize in healthcare marketing and understand the unique challenges medical practices face in today's digital landscape.

Would you be interested in a complimentary consultation to discuss how we can help ${clinicName} attract more patients?

Best regards,
WeTechForU Marketing Team
Phone: (555) 123-TECH
Email: contact@wetechforu.com`;

            if (email) {
                window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            } else {
                navigator.clipboard.writeText(`${subject}\n\n${body}`).then(() => {
                    alert('Contact message copied to clipboard! You can paste it into your email client.');
                });
            }
        }

        function filterLeads(status) {
            const rows = document.querySelectorAll('.lead-row');
            rows.forEach(row => {
                if (status === 'all' || row.dataset.status === status) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function exportLeads() {
            alert('Export functionality would download a CSV file with all lead data');
        }
    </script>
</body>
</html>


