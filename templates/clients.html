<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Management - Health Clinic Marketing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
        }
        .nav-link {
            color: #ecf0f1;
            transition: all 0.3s;
        }
        .nav-link:hover {
            color: #3498db;
            background-color: rgba(52, 152, 219, 0.1);
        }
        .client-card {
            transition: transform 0.2s;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .client-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .status-badge {
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-none d-md-block sidebar">
                <div class="sidebar-sticky p-3">
                    <h4 class="text-white mb-4">
                        <i class="fas fa-heartbeat"></i> HealthMarketing
                    </h4>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/clients">
                                <i class="fas fa-users"></i> Clients
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/campaigns">
                                <i class="fas fa-bullhorn"></i> Campaigns
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/scrape_clinics">
                                <i class="fas fa-search"></i> Clinic Scraper
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/seo_audit">
                                <i class="fas fa-chart-line"></i> SEO Audit
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/analytics">
                                <i class="fas fa-analytics"></i> Analytics
                            </a>
                        </li>
                        <li class="nav-item mt-3">
                            <a class="nav-link text-danger" href="/logout">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-10 ml-sm-auto px-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Client Management</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <a href="/add_client" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add New Client
                        </a>
                    </div>
                </div>

                <!-- Client Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-primary">{{ clients|length }}</h5>
                                <p class="card-text">Total Clients</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-success">{{ clients|selectattr('is_active', 'equalto', true)|list|length }}</h5>
                                <p class="card-text">Active Clients</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-warning">0</h5>
                                <p class="card-text">Pending</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-info">${{ "%.2f"|format(clients|sum(attribute='monthly_retainer', start=0) or 0) }}</h5>
                                <p class="card-text">Monthly Revenue</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Clients List -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">All Clients</h5>
                    </div>
                    <div class="card-body">
                        {% if clients %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Clinic Name</th>
                                        <th>Contact</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Monthly Retainer</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for client in clients %}
                                    <tr>
                                        <td>
                                            <a href="/admin/client/{{ client.id }}" class="text-decoration-none">
                                                <strong class="text-primary">{{ client.client_name }}</strong>
                                            </a>
                                            {% if client.website %}
                                            <br><small class="text-muted">{{ client.website }}</small>
                                            {% endif %}
                                        </td>
                                        <td>{{ client.contact_name or 'N/A' }}</td>
                                        <td>{{ client.email }}</td>
                                        <td>{{ client.phone or 'N/A' }}</td>
                                        <td>
                                            {% if client.is_active %}
                                                <span class="badge bg-success status-badge">Active</span>
                                            {% else %}
                                                <span class="badge bg-secondary status-badge">Inactive</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if client.monthly_retainer %}
                                                ${{ "%.2f"|format(client.monthly_retainer) }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a href="/admin/client/{{ client.id }}" class="btn btn-outline-success" title="Manage Client">
                                                    <i class="fas fa-cogs"></i>
                                                </a>
                                                <button type="button" class="btn btn-outline-primary" onclick="viewClient('{{ client.id }}')" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <a href="/client/{{ client.id }}/communications" class="btn btn-outline-info" title="Communications">
                                                    <i class="fas fa-comments"></i>
                                                </a>
                                                <button type="button" class="btn btn-outline-success" onclick="runSEOAudit('{{ client.website }}', {{ client.id }})" title="SEO Audit">
                                                    <i class="fas fa-chart-line"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-warning" onclick="sendReport({{ client.id }})" title="Send Report">
                                                    <i class="fas fa-paper-plane"></i>
                                                </button>
                                            </div>
                                            <div class="btn-group btn-group-sm mt-1" role="group">
                                                <button type="button" class="btn btn-outline-danger" onclick="updateGoogleListing({{ client.id }})" title="Update Google My Business">
                                                    <i class="fab fa-google"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-primary" onclick="postHealthContent({{ client.id }})" title="Post Health Content">
                                                    <i class="fab fa-facebook"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-success" onclick="sendNewsletter({{ client.id }})" title="Send Patient Newsletter">
                                                    <i class="fas fa-newspaper"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5>No Clients Yet</h5>
                            <p class="text-muted">Start by adding your first client or converting leads from the scraper.</p>
                            <a href="/add_client" class="btn btn-primary">Add Your First Client</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function viewClient(clientId) {
            // Implement client view functionality
            alert('View client details for ID: ' + clientId);
        }

        function editClient(clientId) {
            // Implement client edit functionality
            alert('Edit client for ID: ' + clientId);
        }

        function runSEOAudit(website, clientId) {
            if (!website) {
                alert('No website available for this client');
                return;
            }
            
            if (confirm('Run SEO audit for ' + website + '?')) {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;

                fetch('/api/seo-audit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({url: website, client_id: clientId})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('SEO audit completed! Score: ' + data.audit_results.score + '/100\n\nReport is ready to send to client.');
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred during the audit');
                })
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            }
        }

        function sendReport(clientId) {
            if (confirm('Send SEO report to this client via email?')) {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;

                fetch('/send-report/' + clientId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({report_type: 'seo_audit'})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Professional SEO report sent successfully!\n\nCommunication has been logged in the system.');
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while sending the report');
                })
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            }
        }

        // Healthcare Marketing API Functions
        function updateGoogleListing(clientId) {
            if (confirm('Update Google My Business listing for this clinic?\n\nThis will improve local SEO and patient discovery.')) {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;

                fetch('/api/update-google-listing/' + clientId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let alertMessage = '✅ Google My Business Analysis Complete!\n\n' + 
                              'Real Analysis Results:\n' +
                              '• Current Score: ' + (data.current_score || 'Analyzed') + '\n' +
                              '• Website Status: ' + (data.website_status || 'Checked') + '\n' +
                              '• Visibility Increase: ' + data.visibility_increase + '\n' +
                              '• Expected Patients: ' + data.expected_patients;
                        
                        if (data.improvements_needed && data.improvements_needed.length > 0) {
                            alertMessage += '\n\nImprovements Needed:\n';
                            data.improvements_needed.forEach(improvement => {
                                alertMessage += '• ' + improvement + '\n';
                            });
                        }
                        
                        alert(alertMessage);
                    } else {
                        alert('❌ Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating Google listing');
                })
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            }
        }

        function postHealthContent(clientId) {
            if (confirm('Generate and post health education content?\n\nThis will engage patients and build medical authority.')) {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;

                fetch('/api/post-health-content/' + clientId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let alertMessage = '✅ Health Education Content Generated!\n\n' + 
                              'Real Content Analysis:\n' +
                              '• Quality Score: ' + (data.content_quality_score || 'Optimized') + '\n' +
                              '• Estimated Reach: ' + (data.estimated_reach || data.expected_reach) + '\n' +
                              '• Engagement Rate: ' + data.engagement_rate + '\n' +
                              '• Appointment Increase: ' + data.appointment_increase;
                        
                        if (data.content_analysis) {
                            alertMessage += '\n\nContent Analysis:\n';
                            alertMessage += '• Length: ' + data.content_analysis.length + '\n';
                            alertMessage += '• Hashtags: ' + data.content_analysis.hashtags + '\n';
                            alertMessage += '• Local Target: ' + data.content_analysis.local_targeting + '\n';
                            alertMessage += '• Specialty: ' + data.content_analysis.specialty_focus;
                        }
                        
                        alert(alertMessage);
                    } else {
                        alert('❌ Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while posting content');
                })
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            }
        }

        function sendNewsletter(clientId) {
            if (confirm('Send patient education newsletter?\n\nThis will improve patient retention and engagement.')) {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;

                fetch('/api/send-patient-newsletter/' + clientId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let alertMessage = '✅ Patient Newsletter Generated!\n\n';
                        
                        if (data.recipient_analysis) {
                            alertMessage += 'Real Patient Analysis:\n' +
                                          '• Estimated Patients: ' + data.recipient_analysis.estimated_patients + '\n' +
                                          '• Target Area: ' + data.recipient_analysis.geographic_reach + '\n' +
                                          '• Specialty Focus: ' + data.recipient_analysis.specialty_focus + '\n\n';
                        }
                        
                        if (data.performance_metrics) {
                            alertMessage += 'Expected Performance:\n' +
                                          '• Open Rate: ' + data.performance_metrics.expected_open_rate + '\n' +
                                          '• Click Rate: ' + data.performance_metrics.expected_click_rate + '\n' +
                                          '• Appointment Increase: ' + data.performance_metrics.appointment_bookings + '\n' +
                                          '• Patient Retention: ' + data.performance_metrics.patient_retention;
                        } else {
                            alertMessage += 'Expected Results:\n' +
                                          '• Recipients: ' + (data.recipients || 'Calculated') + '\n' +
                                          '• Open rate: ' + (data.expected_open_rate || 'Optimized') + '\n' +
                                          '• Appointment bookings: ' + data.appointment_bookings;
                        }
                        
                        alert(alertMessage);
                    } else {
                        alert('❌ Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while sending newsletter');
                })
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            }
        }
    </script>
</body>
</html>
