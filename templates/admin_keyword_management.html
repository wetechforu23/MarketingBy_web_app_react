<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyword Management - Admin Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .keyword-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }
        .keyword-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .campaign-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .status-active { background-color: #d4edda; color: #155724; }
        .status-paused { background-color: #fff3cd; color: #856404; }
        .status-completed { background-color: #d1ecf1; color: #0c5460; }
        .progress-ring {
            width: 60px;
            height: 60px;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }
        .backlink-card {
            border-left: 4px solid #28a745;
        }
        .ads-card {
            border-left: 4px solid #ffc107;
        }
        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/admin">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/clients">
                                <i class="fas fa-users"></i> Clients
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/admin/keyword-management">
                                <i class="fas fa-key"></i> Keyword Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/campaigns">
                                <i class="fas fa-bullhorn"></i> Campaigns
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/leads">
                                <i class="fas fa-search"></i> Lead Finder
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/users">
                                <i class="fas fa-user-cog"></i> User Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/logout">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="fas fa-key text-primary"></i> Keyword Management
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
                            <i class="fas fa-plus"></i> Create Campaign
                        </button>
                    </div>
                </div>

                <!-- Client Selection -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="clientSelect" class="form-label">Select Client</label>
                        <select class="form-select" id="clientSelect" onchange="loadClientData()">
                            <option value="">Choose a client...</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}" {% if selected_client and selected_client.id == client.id %}selected{% endif %}>
                                {{ client.clinic_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Quick Actions</label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="generateKeywordStrategy()">
                                <i class="fas fa-magic"></i> Generate Strategy
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="updateRankings()">
                                <i class="fas fa-sync"></i> Update Rankings
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="exportReport()">
                                <i class="fas fa-download"></i> Export Report
                            </button>
                        </div>
                    </div>
                </div>

                {% if selected_client %}
                <!-- Client Overview -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Active Keywords</h5>
                                <h2 class="mb-0">{{ keyword_campaigns|length }}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Backlinks</h5>
                                <h2 class="mb-0">{{ backlink_campaigns|length }}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Google Ads</h5>
                                <h2 class="mb-0">{{ ads_campaigns|length }}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Avg. Progress</h5>
                                <h2 class="mb-0">{{ "%.0f"|format(average_progress) }}%</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campaign Tabs -->
                <ul class="nav nav-tabs" id="campaignTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="keyword-tab" data-bs-toggle="tab" data-bs-target="#keyword-campaigns" type="button" role="tab">
                            <i class="fas fa-key"></i> Keyword Campaigns
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="backlink-tab" data-bs-toggle="tab" data-bs-target="#backlink-campaigns" type="button" role="tab">
                            <i class="fas fa-link"></i> Backlink Campaigns
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ads-tab" data-bs-toggle="tab" data-bs-target="#ads-campaigns" type="button" role="tab">
                            <i class="fas fa-ad"></i> Google Ads
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                            <i class="fas fa-chart-line"></i> Analytics
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="campaignTabContent">
                    <!-- Keyword Campaigns Tab -->
                    <div class="tab-pane fade show active" id="keyword-campaigns" role="tabpanel">
                        <div class="row mt-3">
                            {% for campaign in keyword_campaigns %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card keyword-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title">{{ campaign.campaign_name }}</h6>
                                            <span class="campaign-status status-{{ campaign.status }}">
                                                {{ campaign.status.title() }}
                                            </span>
                                        </div>
                                        <p class="card-text text-muted small">{{ campaign.campaign_type.title() }} Campaign</p>
                                        
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="progress-ring me-3">
                                                <svg class="progress-ring" viewBox="0 0 60 60">
                                                    <circle cx="30" cy="30" r="25" fill="none" stroke="#e0e0e0" stroke-width="4"/>
                                                    <circle cx="30" cy="30" r="25" fill="none" stroke="#007bff" stroke-width="4"
                                                            stroke-dasharray="{{ 2 * 3.14159 * 25 }}"
                                                            stroke-dashoffset="{{ 2 * 3.14159 * 25 * (1 - campaign.progress_percentage / 100) }}"
                                                            transform="rotate(-90 30 30)"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ "%.0f"|format(campaign.progress_percentage) }}%</div>
                                                <small class="text-muted">Progress</small>
                                            </div>
                                        </div>
                                        
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <small class="text-muted">Target</small>
                                                <div class="fw-bold">#{{ campaign.target_ranking }}</div>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Current</small>
                                                <div class="fw-bold">#{{ campaign.current_ranking or 'N/A' }}</div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <button class="btn btn-sm btn-outline-primary" onclick="editCampaign({{ campaign.id }})">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-sm btn-outline-success" onclick="updateProgress({{ campaign.id }})">
                                                <i class="fas fa-sync"></i> Update
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Backlink Campaigns Tab -->
                    <div class="tab-pane fade" id="backlink-campaigns" role="tabpanel">
                        <div class="row mt-3">
                            {% for campaign in backlink_campaigns %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card backlink-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title">{{ campaign.source_domain }}</h6>
                                            <span class="campaign-status status-{{ campaign.status }}">
                                                {{ campaign.status.title() }}
                                            </span>
                                        </div>
                                        <p class="card-text text-muted small">
                                            <strong>DA:</strong> {{ campaign.domain_authority or 'N/A' }} | 
                                            <strong>Cost:</strong> ${{ "%.0f"|format(campaign.cost) }}
                                        </p>
                                        <p class="card-text">
                                            <small><strong>Anchor:</strong> {{ campaign.anchor_text or 'N/A' }}</small><br>
                                            <small><strong>Type:</strong> {{ campaign.link_type or 'N/A' }}</small>
                                        </p>
                                        <div class="mt-3">
                                            <button class="btn btn-sm btn-outline-primary" onclick="editBacklink({{ campaign.id }})">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-sm btn-outline-success" onclick="checkBacklink({{ campaign.id }})">
                                                <i class="fas fa-check"></i> Check
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Google Ads Tab -->
                    <div class="tab-pane fade" id="ads-campaigns" role="tabpanel">
                        <div class="row mt-3">
                            {% for campaign in ads_campaigns %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card ads-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title">{{ campaign.campaign_name }}</h6>
                                            <span class="campaign-status status-{{ campaign.status }}">
                                                {{ campaign.status.title() }}
                                            </span>
                                        </div>
                                        <p class="card-text text-muted small">
                                            <strong>Budget:</strong> ${{ "%.0f"|format(campaign.daily_budget) }}/day
                                        </p>
                                        
                                        <div class="row text-center mb-3">
                                            <div class="col-4">
                                                <small class="text-muted">Impressions</small>
                                                <div class="fw-bold">{{ campaign.impressions }}</div>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">Clicks</small>
                                                <div class="fw-bold">{{ campaign.clicks }}</div>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">CTR</small>
                                                <div class="fw-bold">{{ "%.1f"|format(campaign.ctr) }}%</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row text-center mb-3">
                                            <div class="col-6">
                                                <small class="text-muted">Cost</small>
                                                <div class="fw-bold">${{ "%.2f"|format(campaign.cost) }}</div>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">CPC</small>
                                                <div class="fw-bold">${{ "%.2f"|format(campaign.cpc) }}</div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <button class="btn btn-sm btn-outline-primary" onclick="editAdsCampaign({{ campaign.id }})">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-sm btn-outline-success" onclick="syncAdsData({{ campaign.id }})">
                                                <i class="fas fa-sync"></i> Sync
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Analytics Tab -->
                    <div class="tab-pane fade" id="analytics" role="tabpanel">
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-chart-line"></i> Keyword Performance</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="keywordChart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-chart-pie"></i> Campaign Distribution</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="campaignChart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-table"></i> Performance Summary</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>Campaign</th>
                                                        <th>Type</th>
                                                        <th>Progress</th>
                                                        <th>Cost</th>
                                                        <th>ROI</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for campaign in all_campaigns %}
                                                    <tr>
                                                        <td>{{ campaign.name }}</td>
                                                        <td>{{ campaign.type }}</td>
                                                        <td>
                                                            <div class="progress" style="height: 20px;">
                                                                <div class="progress-bar" style="width: {{ campaign.progress }}%">
                                                                    {{ campaign.progress }}%
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td>${{ "%.2f"|format(campaign.cost) }}</td>
                                                        <td>{{ "%.1f"|format(campaign.roi) }}%</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary" onclick="viewDetails({{ campaign.id }})">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-key fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Select a client to manage keywords</h4>
                    <p class="text-muted">Choose a client from the dropdown above to view and manage their keyword campaigns.</p>
                </div>
                {% endif %}
            </main>
        </div>
    </div>

    <!-- Create Campaign Modal -->
    <div class="modal fade" id="createCampaignModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Campaign</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createCampaignForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="campaignName" class="form-label">Campaign Name</label>
                                    <input type="text" class="form-control" id="campaignName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="campaignType" class="form-label">Campaign Type</label>
                                    <select class="form-select" id="campaignType" required>
                                        <option value="">Select type...</option>
                                        <option value="seo">SEO Campaign</option>
                                        <option value="google_ads">Google Ads</option>
                                        <option value="facebook">Facebook Ads</option>
                                        <option value="content">Content Marketing</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="targetKeywords" class="form-label">Target Keywords</label>
                            <textarea class="form-control" id="targetKeywords" rows="3" placeholder="Enter keywords separated by commas"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="budget" class="form-label">Budget ($)</label>
                                    <input type="number" class="form-control" id="budget" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="targetRanking" class="form-label">Target Ranking</label>
                                    <input type="number" class="form-control" id="targetRanking" min="1" max="100" value="1">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="campaignNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="campaignNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createCampaign()">Create Campaign</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function loadClientData() {
            const clientId = document.getElementById('clientSelect').value;
            if (clientId) {
                window.location.href = `/admin/keyword-management?client_id=${clientId}`;
            }
        }

        function generateKeywordStrategy() {
            const clientId = document.getElementById('clientSelect').value;
            if (clientId) {
                fetch(`/admin/generate-keyword-strategy/${clientId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Keyword strategy generated successfully!');
                        location.reload();
                    } else {
                        alert('Error generating strategy: ' + data.error);
                    }
                });
            } else {
                alert('Please select a client first');
            }
        }

        function updateRankings() {
            const clientId = document.getElementById('clientSelect').value;
            if (clientId) {
                fetch(`/admin/update-rankings/${clientId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Rankings updated successfully!');
                        location.reload();
                    } else {
                        alert('Error updating rankings: ' + data.error);
                    }
                });
            } else {
                alert('Please select a client first');
            }
        }

        function exportReport() {
            const clientId = document.getElementById('clientSelect').value;
            if (clientId) {
                window.open(`/admin/export-keyword-report/${clientId}`, '_blank');
            } else {
                alert('Please select a client first');
            }
        }

        function createCampaign() {
            const clientId = document.getElementById('clientSelect').value;
            if (!clientId) {
                alert('Please select a client first');
                return;
            }

            const formData = {
                client_id: clientId,
                campaign_name: document.getElementById('campaignName').value,
                campaign_type: document.getElementById('campaignType').value,
                target_keywords: document.getElementById('targetKeywords').value.split(',').map(k => k.trim()),
                budget: parseFloat(document.getElementById('budget').value) || 0,
                target_ranking: parseInt(document.getElementById('targetRanking').value),
                notes: document.getElementById('campaignNotes').value
            };

            fetch('/admin/create-keyword-campaign', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Campaign created successfully!');
                    location.reload();
                } else {
                    alert('Error creating campaign: ' + data.error);
                }
            });
        }

        function editCampaign(campaignId) {
            // Implementation for editing campaigns
            alert('Edit campaign functionality coming soon!');
        }

        function updateProgress(campaignId) {
            fetch(`/admin/update-campaign-progress/${campaignId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Progress updated successfully!');
                    location.reload();
                } else {
                    alert('Error updating progress: ' + data.error);
                }
            });
        }

        function editBacklink(backlinkId) {
            // Implementation for editing backlinks
            alert('Edit backlink functionality coming soon!');
        }

        function checkBacklink(backlinkId) {
            fetch(`/admin/check-backlink/${backlinkId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Backlink status updated!');
                    location.reload();
                } else {
                    alert('Error checking backlink: ' + data.error);
                }
            });
        }

        function editAdsCampaign(campaignId) {
            // Implementation for editing ads campaigns
            alert('Edit ads campaign functionality coming soon!');
        }

        function syncAdsData(campaignId) {
            fetch(`/admin/sync-ads-data/${campaignId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Ads data synced successfully!');
                    location.reload();
                } else {
                    alert('Error syncing ads data: ' + data.error);
                }
            });
        }

        function viewDetails(campaignId) {
            // Implementation for viewing campaign details
            alert('View details functionality coming soon!');
        }

        // Initialize charts when analytics tab is shown
        document.getElementById('analytics-tab').addEventListener('shown.bs.tab', function() {
            // Initialize keyword performance chart
            const keywordCtx = document.getElementById('keywordChart').getContext('2d');
            new Chart(keywordCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Average Ranking',
                        data: [12, 19, 3, 5, 2, 3],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            reverse: true
                        }
                    }
                }
            });

            // Initialize campaign distribution chart
            const campaignCtx = document.getElementById('campaignChart').getContext('2d');
            new Chart(campaignCtx, {
                type: 'doughnut',
                data: {
                    labels: ['SEO', 'Google Ads', 'Facebook', 'Content'],
                    datasets: [{
                        data: [30, 25, 20, 25],
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        });
    </script>
</body>
</html>


